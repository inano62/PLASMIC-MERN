ã„ã„ã‚ˆï¼ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã«æœ€é©åŒ–ã—ãŸ **MERNï¼ˆMongoDB / Express / React / Nodeï¼‰** ã® `docker-compose.yml` ã‚’ç½®ãã¾ã™ã€‚
Windows ã§ã‚‚ HMR ãŒå®‰å®šã™ã‚‹ã‚ˆã†ã«ãƒãƒ¼ãƒªãƒ³ã‚°ï¼†HMRãƒãƒ¼ãƒˆã‚’å…¥ã‚Œã¦ã¾ã™ã€‚`mongo-express` ã¯ä»»æ„ï¼ˆprofileï¼‰ã§ã™ã€‚

```yaml
# docker-compose.yml
name: mern-stack

services:
  # 1) API (Node/Express)
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: mern-api
    working_dir: /usr/src/app
    command: sh -lc "npm ci || npm install && npm run dev"
    environment:
      NODE_ENV: development
      PORT: "5000"
      MONGO_URI: "mongodb://mongo:27017/mern?retryWrites=true&w=majority"
      # CORS å‘ã‘ï¼ˆå¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ï¼‰
      CLIENT_ORIGIN: "http://localhost:5173"
    ports:
      - "5000:5000"
    volumes:
      - ./api:/usr/src/app
    depends_on:
      mongo:
        condition: service_healthy
    networks: [mern_net]
    healthcheck:
      test: ["CMD-SHELL", "node -e \"http=require('http');r=http.request({host:'localhost',port:5000,path:'/health'},res=>process.exit(res.statusCode===200?0:1));r.on('error',()=>process.exit(1));r.end()\""]
      interval: 30s
      timeout: 5s
      retries: 5

  # 2) Client (React + Vite)
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: mern-client
    working_dir: /usr/src/app
    command: sh -lc "npm ci || npm install && npm run dev -- --host --strictPort"
    environment:
      # Windows/WSL ã®ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ã‚’å®‰å®šåŒ–
      CHOKIDAR_USEPOLLING: "true"
      WATCHPACK_POLLING: "true"
      VITE_FS_USE_POLLING: "true"
      # API ã®ã‚ªãƒªã‚¸ãƒ³ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã«æ¸¡ã™
      VITE_API_ORIGIN: "http://localhost:5000"
    ports:
      - "5173:5173"   # Vite dev
      - "24678:24678" # HMR WebSocket æ˜ç¤º
    volumes:
      - ./client:/usr/src/app
    depends_on:
      api:
        condition: service_started
    networks: [mern_net]

  # 3) MongoDB
  mongo:
    image: mongo:7-jammy
    container_name: mern-mongo
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: mern
    volumes:
      - mongo_data:/data/db
      # åˆæœŸãƒ‡ãƒ¼ã‚¿/ãƒ¦ãƒ¼ã‚¶ãŒå¿…è¦ãªã‚‰ ./mongo/init.js ã‚’ã“ã“ã«ç½®ã
      # - ./mongo/init.js:/docker-entrypoint-initdb.d/init.js:ro
    networks: [mern_net]
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval 'db.runCommand({ ping: 1 }).ok' | grep 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  # 4) Mongo Express (ä»»æ„: ãƒ–ãƒ©ã‚¦ã‚¶ç®¡ç†ãƒ„ãƒ¼ãƒ«)
  mongo-express:
    image: mongo-express:1.0.2-18
    profiles: ["tools"]         # â† `--profile tools` ã§æœ‰åŠ¹åŒ–
    container_name: mern-me
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_URL: "mongodb://mongo:27017/mern"
    depends_on:
      mongo:
        condition: service_started
    networks: [mern_net]

networks:
  mern_net:
    driver: bridge

volumes:
  mongo_data:
```

---

### æœ€å° Dockerfileï¼ˆå¿…è¦ãªã‚‰ãã®ã¾ã¾ç½®ã„ã¦OKï¼‰

**`api/Dockerfile`**

```dockerfile
FROM node:20-alpine
WORKDIR /usr/src/app
# ä¾å­˜ã¯èµ·å‹•æ™‚ã«å…¥ã‚Œã‚‹é‹ç”¨ï¼ˆé–‹ç™ºï¼‰
```

**`client/Dockerfile`**

```dockerfile
FROM node:20-alpine
WORKDIR /usr/src/app
```

---

### API å´ã®é››å½¢ï¼ˆæŠœç²‹ï¼‰

**`api/package.json`**

```json
{
  "name": "mern-api",
  "type": "module",
  "scripts": {
    "dev": "nodemon --watch src --ext ts,js,json --exec node src/index.js"
  },
  "dependencies": {
    "cors": "^2.8.5",
    "express": "^4.19.2",
    "mongoose": "^8.5.1"
  },
  "devDependencies": { "nodemon": "^3.1.0" }
}
```

**`api/src/index.js`**

```js
import express from "express";
import cors from "cors";
import mongoose from "mongoose";

const app = express();
app.use(express.json());
app.use(cors({ origin: process.env.CLIENT_ORIGIN ?? "*" }));

app.get("/health", (_req, res) => res.status(200).json({ ok: true }));

const uri = process.env.MONGO_URI ?? "mongodb://mongo:27017/mern";
await mongoose.connect(uri);

app.get("/api/hello", (_req, res) => res.json({ message: "Hello MERN!" }));

const port = process.env.PORT ?? 5000;
app.listen(port, () => console.log(`API on :${port}`));
```

---

### Client å´ã®é››å½¢ï¼ˆViteï¼‰

**`client/package.json`**

```json
{
  "name": "mern-client",
  "private": true,
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview --host"
  },
  "dependencies": {
    "react": "^18.3.1",
    "react-dom": "^18.3.1"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.3.0",
    "vite": "^5.4.0"
  }
}
```

**`client/vite.config.ts`ï¼ˆJSã§ã‚‚å¯ï¼‰**

```ts
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
export default defineConfig({
  plugins: [react()],
  server: {
    host: true,
    port: 5173,
    strictPort: true,
    hmr: { port: 24678, clientPort: 24678 }
  }
});
```

**`client/src/main.tsx`**

```tsx
import { createRoot } from "react-dom/client";
function App() {
  const onClick = async () => {
    const r = await fetch((import.meta.env.VITE_API_ORIGIN ?? "") + "/api/hello");
    alert(JSON.stringify(await r.json()));
  };
  return <button onClick={onClick}>Ping API</button>;
}
createRoot(document.getElementById("root")!).render(<App />);
```

---

### ä½¿ã„æ–¹

```bash
# ç«‹ã¡ä¸Šã’
docker compose up -d --build

# å¿…è¦ãªã‚‰ mongo-express ã‚‚
docker compose --profile tools up -d

# å‹•ä½œãƒã‚§ãƒƒã‚¯
curl http://localhost:5000/health
open http://localhost:5173
# mongo-express: http://localhost:8081  ï¼ˆtools profileã‚’æœ‰åŠ¹ã«ã—ãŸå ´åˆï¼‰
```

å¿…è¦ã«å¿œã˜ã¦ã€`MONGO_URI` ã‚„ CORS ã® `CLIENT_ORIGIN` ã‚’æœ¬ç•ªå€¤ã«å·®ã—æ›¿ãˆã¦ã­ã€‚
ä»–ã«ã‚‚ã€Œæœ¬ç•ªãƒ“ãƒ«ãƒ‰ã§ Nginx é…ä¿¡ã«åˆ‡ã‚Šæ›¿ãˆã‚‹æ§‹æˆã€ã‚‚å‡ºã›ã‚‹ã‘ã©ã€ã“ã® compose ã¯**é–‹ç™ºã‚¹ãƒ”ãƒ¼ãƒ‰æœ€å„ªå…ˆ**ã§å®‰å®šã—ã¾ã™ã€‚
âœ… ã“ã‚Œã§ MERN ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆMongo / Express / React / Nodeï¼‰ãŒ 1ã‚³ãƒãƒ³ãƒ‰ã§å…¨éƒ¨èµ·å‹•ã—ã¾ã™ï¼š
```bash
docker compose up -d --build


git remote set-url origin https://github.com/inano62/PLASMIC-MERN.git
git push -u origin main
```

ğŸ‘‰ 5173 = React
ğŸ‘‰ 5000 = API
ğŸ‘‰ 27017 = MongoDB
ğŸ‘‰ 8081 = mongo-express GUI